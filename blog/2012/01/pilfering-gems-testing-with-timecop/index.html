
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <title>That Damn Cabbage: Pilfering Gems: Testing With Timecop</title>
  <meta name="author" content="Rob Howard" />
  

  

  <link rel="canonical" href="http://robhoward.id.au/blog/2012/01/pilfering-gems-testing-with-timecop/" />
  <link href="/atom.xml" rel="alternate" title="That Damn Cabbage" type="application/atom+xml" />

  <link href="/favicon.png" rel="icon" type="image/png" />
  <link href="/favicon.ico" rel="shortcut icon" />

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>

  <!--
    <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
    <script src="/javascripts/octopress.js" type="text/javascript"></script>
  -->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12459174-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body  >
  <div id="container">
    <nav id="primary" role="navigation"><a class="illustration" href="/">A head of cabbage.</a>
<ul role="main-navigation">
  <li><a href="/">Blog Stream</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://twitter.com/damncabbage">@damncabbage</a></li>
  <li><a href="https://github.com/damncabbage">GitHub</a></li>
  <li><a href="https://github.com/smashcon">SMASH!</a></li> 
  <!-- <li><a href="/projects">Projects</a></li>
  <li><a href="/projects/smash">SMASH!</a></li> -->
</ul>
</nav>
    <div id="content">
      <header id="masthead"><h1><a href="/">That Damn Cabbage</a></h1>

  <p class="tagline">Rob Howard and the Infinite Sadness</p>

</header>
      <article class="hentry">
  
  <header>
    
      <h1 class="entry-title">Pilfering Gems: Testing With Timecop</h1>
    
    
      <p class="meta">Posted on





  <time datetime="2012-01-05 11:32:00 +1100" pubdate  updated >Jan 5<span>th</span>, 2012</time>




  
    under <a class='category' href='/blog/categories/PHP/'>PHP</a>, <a class='category' href='/blog/categories/Pilfering-Gems/'>Pilfering Gems</a>, <a class='category' href='/blog/categories/Ruby/'>Ruby</a>, <a class='category' href='/blog/categories/Testing/'>Testing</a>
  


    
  </header>


<div class="copy"><p><em>This is the first in a short series of posts showing you how to cherry-pick some of the niftier things (libraries, techniques, whatever) from the Ruby world for use in your PHP work.</em></p>

<p><a href="https://github.com/jtrupiano/timecop">Timecop</a> is a library that makes testing time-dependant code a cinch.</p>

<p>The results from a graphing calculator isn&#8217;t going to change if you run it now or next week. Something like a prize-draw competition, though, will produce wildly different results depending when a punter puts in an entry, and testing this is where you wedge Timecop.</p>

<p>Take the example of that prize-draw competition. It&#8217;s initially closed, no entries allowed; it opens for a while, during which you can enter, and then finally, it closes again and a winner is drawn.</p>

<p>Let&#8217;s run through how we tackle testing this with Timecop.<!--more--></p>

<h2>Timecop (Ruby)</h2>

<p>Let&#8217;s assume we have two classes: <code>Competition</code> and <code>Entry</code>. You set up a competition by giving it the open and close dates; calling <code>enter</code> on the competition with your details will give you back an <code>Entry</code> object to interrogate:</p>

<div><figure role=code><figcaption><span>lang=ruby </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>competition = Competition.new(:open => "2012-01-01 09:00", :close => "2015-12-30 23:59")
</div><div class='line'>entry       = competition.enter(:name => "Sam")
</div><div class='line'>entry.valid? # => true</div></code></pre></td></tr></table></div></figure></div>


<p>Pretty simple. To start with, let&#8217;s just get a taste of how to test something like this with Timecop; we&#8217;ll go through the nitty-gritty of setting it up a little further on.</p>

<p>Here&#8217;s a bare-bones <a href="http://rspec.info">RSpec</a> test, with the easiest test case filled out:</p>

<div><figure role=code><figcaption><span>lang=ruby </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>require 'spec_helper'
</div><div class='line'>require 'timecop'
</div><div class='line'>
</div><div class='line'>describe Competition do
</div><div class='line'>  let!(:competition) do
</div><div class='line'>    # Opens a day from now, closes a day after that.
</div><div class='line'>    day = 86400
</div><div class='line'>    Competition.new(:open => Time.now + day, :close => Time.now + day*2)
</div><div class='line'>  end
</div><div class='line'>
</div><div class='line'>  it "should reject early entries" do
</div><div class='line'>    entry = competition.enter(:name => "Bert")
</div><div class='line'>    entry.valid?.should == false
</div><div class='line'>    entry.errors.should include("Too early!")
</div><div class='line'>  end
</div><div class='line'>
</div><div class='line'>  it "should accept timely entries" do
</div><div class='line'>    # TODO
</div><div class='line'>  end
</div><div class='line'>
</div><div class='line'>  it "should reject late entries" do
</div><div class='line'>    # TODO
</div><div class='line'>  end
</div><div class='line'>end</div></code></pre></td></tr></table></div></figure></div>


<p>The open date is always a day from now, so the &#8220;early entry&#8221; condition is easy. The other two are a bit tougher.</p>

<p>Timecop provides a couple of ways of altering time: <code>Timecop.travel</code> (jump to a particular time), or <code>Timecop.freeze</code> (jump to a particular time <em>and</em> freeze the clock). In both cases, a <code>Timecop.return</code> will revert back to reality.</p>

<p>In addition to this, you can pass <code>freeze</code> a block (a closure, eg. <code>do ... end</code>), and have it automatically return for you after the block has been called.</p>

<p>Let&#8217;s fill out those test cases:</p>

<div><figure role=code><figcaption><span>lang=ruby </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>require 'spec_helper'
</div><div class='line'>require 'timecop'
</div><div class='line'>
</div><div class='line'>describe Competition do
</div><div class='line'>  let (:day) { 86400 }
</div><div class='line'>  let!(:competition) do
</div><div class='line'>    # Opens a day from now, closes a day after that.
</div><div class='line'>    Competition.new(:open => Time.now + day, :close => Time.now + day*2)
</div><div class='line'>  end
</div><div class='line'>
</div><div class='line'>  it "should reject early entries" do
</div><div class='line'>    entry = competition.enter(:name => "Bert")
</div><div class='line'>    entry.valid?.should == false
</div><div class='line'>    entry.errors.should include("Too early!")
</div><div class='line'>  end
</div><div class='line'>
</div><div class='line'>  it "should accept timely entries" do
</div><div class='line'>    # A day and a half from now.
</div><div class='line'>    Timecop.freeze(Time.now + day*1.5) do
</div><div class='line'>      entry = competition.enter(:name => "Sam")
</div><div class='line'>      entry.valid?.should == true
</div><div class='line'>    end
</div><div class='line'>  end
</div><div class='line'>
</div><div class='line'>  it "should reject late entries" do
</div><div class='line'>    # Three days from now, after competition closure.
</div><div class='line'>    Timecop.freeze(Time.now + day*3) do
</div><div class='line'>      entry = competition.enter(:name => "Frank")
</div><div class='line'>      entry.valid?.should == false
</div><div class='line'>      entry.errors.should include("Too late!")
</div><div class='line'>    end
</div><div class='line'>  end
</div><div class='line'>end</div></code></pre></td></tr></table></div></figure></div>


<p>You can get the sample classes, full test suite and running instructions from <a href="https://github.com/damncabbage/pilfering-gems-examples/blob/master/timecop/ruby">the ruby directory in this GitHub project</a>.</p>

<h2>Timecop-PHP</h2>

<p>Timecop was <a href="https://github.com/erikfercak/Timecop-PHP">ported to PHP by Erik Ferčák</a>. It depends on PHP5.3+ and the <a href="Runkit%20Extension">https://github.com/zenovich/runkit.git</a> (in order to mess around with core functions, such as <code>time()</code>).</p>

<p>Again, let&#8217;s just run through an example before diving into setting it up.</p>

<p>Starting with a basic PHPUnit test case, again with the easiest test case filled out:</p>

<div><figure role=code><figcaption><span>lang=php </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>&lt;?php
</div><div class='line'>require_once dirname(__FILE__).'/../lib/Competition.php';
</div><div class='line'>require_once dirname(__FILE__).'/../lib/Entry.php';
</div><div class='line'>require_once dirname(__FILE__).'/support/Timecop.php';
</div><div class='line'>
</div><div class='line'>class CompetitionTest extends PHPUnit_Framework_TestCase
</div><div class='line'>{
</div><div class='line'>    protected $competition;
</div><div class='line'>
</div><div class='line'>    public function setUp() {
</div><div class='line'>        // Opens a day from now, closes a day after that.
</div><div class='line'>        $this->competition = new Competition($opens = strtotime('+1 day'), $closes = strtotime('+2 day'));
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    public function testEarlyEntry() {
</div><div class='line'>        $entry = $this->competition->enter(array('name' => 'Bert'));
</div><div class='line'>        $this->assertFalse($entry->isValid());
</div><div class='line'>        $this->assertContains("Too early!", $entry->errors);
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    public function testTimelyEntry() {
</div><div class='line'>        // TODO
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    public function testLateEntry() {
</div><div class='line'>        // TODO
</div><div class='line'>    }
</div><div class='line'>}</div></code></pre></td></tr></table></div></figure></div>


<p>(If you wish, you can set this up to autoload later by putting Timecop.php into <code>/usr/share/php</code>, or wherever else your PEAR directory is.)</p>

<p>Timecop-PHP provides a similar way to hop around to it&#8217;s Ruby progenitor. Before jumping through time, though, you need to tell Timecop to prepare first with <code>Timecop::warpTime()</code>.
After that, you can use <code>Timecop::travel()</code> to move forward and back through time. <code>Timecop::freeze()</code> is also supported, but you must first call <code>travel()</code> to set the destination time.</p>

<p>Here are the rest of the entry test cases, using Timecop to leap forward through the three competition states:</p>

<div><figure role=code><figcaption><span>lang=php </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
<span class='line'>43</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>&lt;?php
</div><div class='line'>require_once dirname(__FILE__).'/support/Timecop/lib/Timecop.php';
</div><div class='line'>
</div><div class='line'>class CompetitionTest extends PHPUnit_Framework_TestCase
</div><div class='line'>{
</div><div class='line'>    const DAY_IN_SECONDS = 86400;
</div><div class='line'>
</div><div class='line'>    protected $competition;
</div><div class='line'>
</div><div class='line'>    // Runs before each test
</div><div class='line'>    public function setUp() {
</div><div class='line'>        // Opens a day from now, closes a day after that.
</div><div class='line'>        $this->competition = new Competition($opens = strtotime('+1 day'), $closes = strtotime('+2 day'));
</div><div class='line'>        Timecop::warpTime(); // Setup
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    public function testEarlyEntry() {
</div><div class='line'>        $entry = $this->competition->enter(array('name' => 'Bert'));
</div><div class='line'>        $this->assertFalse($entry->isValid());
</div><div class='line'>        $this->assertContains("Too early!", $entry->errors);
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    public function testTimelyEntry() {
</div><div class='line'>        // Jump a day and a half from now.
</div><div class='line'>        Timecop::travel(time() + self::DAY_IN_SECONDS * 1.5);
</div><div class='line'>        $entry = $this->competition->enter(array('name' => 'Sam'));
</div><div class='line'>        $this->assertTrue($entry->isValid());
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    public function testLateEntry() {
</div><div class='line'>        // Jump three days from now.
</div><div class='line'>        Timecop::travel(time() + self::DAY_IN_SECONDS * 3);
</div><div class='line'>        $entry = $this->competition->enter(array('name' => 'Frank'));
</div><div class='line'>        $this->assertFalse($entry->isValid());
</div><div class='line'>        $this->assertContains("Too late!", $entry->errors);
</div><div class='line'>    }
</div><div class='line'>
</div><div class='line'>    // Runs after each test
</div><div class='line'>    public function tearDown() {
</div><div class='line'>        // Always make sure we're back in the present.
</div><div class='line'>        Timecop::unwarpTime();
</div><div class='line'>    }
</div><div class='line'>}</div></code></pre></td></tr></table></div></figure></div>


<p>You can get the sample classes, full test suite and running instructions from <a href="https://github.com/damncabbage/pilfering-gems-examples/blob/master/timecop/php">the php directory in this GitHub project</a>.</p>
</div>



  
</article>

    </div>
    <footer><p>
  Copyright &copy; 2012, Rob Howard - <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>
</footer>
  </div>
</body>
</html>
